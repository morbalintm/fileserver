/* ===============================
   VIRTUAL FILE SYSTEM ENGINE
================================ */

let fs = users[currentUser]?.fs || {root:{home:{}}};
let currentPath = ["root","home"];

/* HELPERS */

function getCurrentDir(){
    let dir = fs;
    currentPath.forEach(p=>{dir=dir[p];});
    return dir;
}

function pathToString(){ return "/"+currentPath.slice(1).join("/"); }

/* ===============================
   FILE MANAGER APP
================================ */

function buildFileManager(rootDiv){
    const container = document.getElementById(rootDiv);
    container.innerHTML = "";

    const toolbar = document.createElement("div");
    toolbar.style.marginBottom="10px";

    const newFileBtn = document.createElement("button");
    newFileBtn.textContent="New File";
    newFileBtn.onclick=createFile;
    toolbar.appendChild(newFileBtn);

    const newFolderBtn = document.createElement("button");
    newFolderBtn.textContent="New Folder";
    newFolderBtn.onclick=createFolder;
    toolbar.appendChild(newFolderBtn);

    const upBtn = document.createElement("button");
    upBtn.textContent="Up";
    upBtn.onclick=()=>{ if(currentPath.length>2) currentPath.pop(); buildFileManager(rootDiv); };
    toolbar.appendChild(upBtn);

    const searchInput = document.createElement("input");
    searchInput.placeholder="Search...";
    searchInput.oninput = ()=>buildFileManager(rootDiv,searchInput.value);
    toolbar.appendChild(searchInput);

    container.appendChild(toolbar);

    const tree = document.createElement("div");
    renderTree(tree,getCurrentDir(),searchInput.value||"");
    container.appendChild(tree);
}

function renderTree(container,dir,filter=""){
    container.innerHTML="";
    Object.keys(dir).forEach(name=>{
        if(filter && !name.toLowerCase().includes(filter.toLowerCase())) return;
        const item = document.createElement("div");
        item.style.padding="5px";
        item.style.cursor="pointer";
        item.textContent=name;

        item.ondblclick = ()=>{
            if(typeof dir[name]==="object"){
                currentPath.push(name);
                buildFileManager("fileManagerRoot");
            } else {
                alert("Open file: "+name);
            }
        };

        item.oncontextmenu = (e)=>{
            e.preventDefault();
            showContextMenu(e.clientX,e.clientY,dir,name);
        };

        container.appendChild(item);
    });
}

/* ===============================
   CONTEXT MENU
================================ */

let menu = null;

function showContextMenu(x,y,dir,name){
    if(menu) menu.remove();
    menu = document.createElement("div");
    menu.style.position="fixed";
    menu.style.top=y+"px";
    menu.style.left=x+"px";
    menu.style.background="rgba(0,0,0,0.8)";
    menu.style.backdropFilter="blur(10px)";
    menu.style.borderRadius="10px";
    menu.style.padding="5px";
    menu.style.zIndex=9999;

    const actions = [
        {name:"Delete",func:()=>{delete dir[name]; buildFileManager("fileManagerRoot"); menu.remove();}},
        {name:"Rename",func:()=>{let nn=prompt("New name",name); if(nn) {dir[nn]=dir[name]; delete dir[name]; buildFileManager("fileManagerRoot"); menu.remove();}}},
        {name:"Copy",func:()=>{dir[name+"_copy"]=dir[name]; buildFileManager("fileManagerRoot"); menu.remove();}}
    ];

    actions.forEach(a=>{
        const b=document.createElement("div");
        b.textContent=a.name;
        b.style.padding="5px 10px";
        b.style.cursor="pointer";
        b.onmouseover=()=>b.style.background="rgba(255,255,255,0.2)";
        b.onmouseout=()=>b.style.background="transparent";
        b.onclick=a.func;
        menu.appendChild(b);
    });

    document.body.appendChild(menu);
    document.addEventListener("click",()=>{ if(menu) menu.remove(); menu=null;},{once:true});
}

/* ===============================
   FILE / FOLDER OPERATIONS
================================ */

function createFile(){
    const name=prompt("File name:");
    if(!name) return;
    getCurrentDir()[name]="";
    users[currentUser].fs=fs;
    saveUsers();
    buildFileManager("fileManagerRoot");
}

function createFolder(){
    const name=prompt("Folder name:");
    if(!name) return;
    getCurrentDir()[name]={};
    users[currentUser].fs=fs;
    saveUsers();
    buildFileManager("fileManagerRoot");
}

/* ===============================
   TERMINAL APP
================================ */

function buildTerminal(rootDiv){
    const container = document.getElementById(rootDiv);
    container.innerHTML="";
    const output = document.createElement("div");
    output.style.height="300px";
    output.style.overflowY="auto";
    output.style.background="black";
    output.style.color="#0f0";
    output.style.padding="10px";
    container.appendChild(output);

    const input = document.createElement("input");
    input.style.width="100%";
    input.style.background="black";
    input.style.color="#0f0";
    container.appendChild(input);
    input.focus();

    input.addEventListener("keydown",e=>{
        if(e.key==="Enter"){
            const cmd = input.value.trim();
            output.innerHTML+="<div>> "+cmd+"</div>";
            executeTerm(cmd,output);
            input.value="";
            output.scrollTop=output.scrollHeight;
        }
    });
}

function executeTerm(cmd,out){
    const [c,arg] = cmd.split(" ");
    switch(c){
        case "ls":
            out.innerHTML+="<div>"+Object.keys(getCurrentDir()).join(" ")+"</div>";
            break;
        case "cd":
            if(arg===".."){ if(currentPath.length>2) currentPath.pop(); }
            else if(getCurrentDir()[arg] && typeof getCurrentDir()[arg]==="object") currentPath.push(arg);
            break;
        case "pwd":
            out.innerHTML+="<div>"+pathToString()+"</div>";
            break;
        case "mkdir":
            if(arg){getCurrentDir()[arg]={}; users[currentUser].fs=fs; saveUsers();}
            break;
        case "touch":
            if(arg){getCurrentDir()[arg]=""; users[currentUser].fs=fs; saveUsers();}
            break;
        case "clear":
            out.innerHTML="";
            break;
        default:
            out.innerHTML+="<div>Command not found</div>";
    }
}

/* ===============================
   APP HOOK
================================ */

function openApp(type){
    let title="",content="",callback=null;

    if(type==="fileManager"){title="File Manager"; content="<div id='fileManagerRoot'></div>"; callback=()=>buildFileManager("fileManagerRoot");}
    if(type==="terminal"){title="Terminal"; content="<div id='terminalRoot'></div>"; callback=()=>buildTerminal("terminalRoot");}
    if(type==="monitor"){title="System Monitor"; content="<div id='monitorRoot'></div>"; callback=()=>buildMonitor("monitorRoot");}

    createWindow(title,content);
    if(callback) callback();
}

/* ===============================
   SYSTEM MONITOR
================================ */

function buildMonitor(rootDiv){
    const container = document.getElementById(rootDiv);
    container.innerHTML="";
    const cpu = document.createElement("div");
    const ram = document.createElement("div");
    container.appendChild(cpu);
    container.appendChild(ram);

    setInterval(()=>{
        cpu.textContent="CPU Usage: "+Math.floor(Math.random()*70)+"%";
        ram.textContent="RAM Usage: "+Math.floor(Math.random()*80)+"%";
    },1500);
}
