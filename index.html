<script>
/* ===============================
   VIRTUAL FILE SYSTEM ENGINE
================================ */
function getCurrentDir(){
    let dir = fs;
    path.forEach(p => { dir = dir[p]; });
    return dir;
}

function pathString(){ return "/"+path.slice(1).join("/"); }

/* ===============================
   FILE MANAGER APP
================================ */
function buildFileManager(){
    const root = document.getElementById("fileManagerRoot");
    root.innerHTML = "";

    // Toolbar
    const toolbar = document.createElement("div"); toolbar.style.marginBottom="10px";

    const newFileBtn = document.createElement("button");
    newFileBtn.textContent = "New File";
    newFileBtn.onclick = () => {
        let n = prompt("File name:"); if(!n) return;
        getCurrentDir()[n] = {type:"file", size:0, created:Date.now()};
        users[currentUser].fs = fs; saveUsers(); buildFileManager();
    };
    toolbar.appendChild(newFileBtn);

    const newFolderBtn = document.createElement("button");
    newFolderBtn.textContent = "New Folder";
    newFolderBtn.onclick = () => {
        let n = prompt("Folder name:"); if(!n) return;
        getCurrentDir()[n] = {type:"folder", children:{}, created:Date.now()};
        users[currentUser].fs = fs; saveUsers(); buildFileManager();
    };
    toolbar.appendChild(newFolderBtn);

    const upBtn = document.createElement("button");
    upBtn.textContent = "Up";
    upBtn.onclick = () => { if(path.length>2) path.pop(); buildFileManager(); };
    toolbar.appendChild(upBtn);

    const searchInput = document.createElement("input");
    searchInput.placeholder = "Search...";
    searchInput.oninput = () => buildFileManagerFiltered(searchInput.value);
    toolbar.appendChild(searchInput);

    root.appendChild(toolbar);

    renderDir(root,getCurrentDir());
}

function buildFileManagerFiltered(filter=""){
    const root = document.getElementById("fileManagerRoot");
    root.innerHTML = "";
    const toolbar = document.createElement("div"); toolbar.style.marginBottom="10px";
    const upBtn = document.createElement("button"); upBtn.textContent="Up";
    upBtn.onclick = () => { if(path.length>2) path.pop(); buildFileManager(); };
    toolbar.appendChild(upBtn);
    root.appendChild(toolbar);

    function renderFiltered(container,dir){
        Object.keys(dir).forEach(name=>{
            if(!name.toLowerCase().includes(filter.toLowerCase())) return;
            const item = document.createElement("div");
            item.className="fm-item"; item.textContent = name;
            item.ondblclick = () => {
                if(dir[name].type==="folder"){ path.push(name); buildFileManager(); }
                else alert("Open file: "+name);
            };
            item.oncontextmenu = e => showContextMenu(e,dir,name);
            container.appendChild(item);
        });
    }
    renderFiltered(root,getCurrentDir());
}

/* ===============================
   CONTEXT MENU
================================ */
let menu = null;
function showContextMenu(e,dir,name){
    if(menu) menu.remove();
    menu = document.createElement("div");
    menu.style.position="fixed"; menu.style.top=e.clientY+"px"; menu.style.left=e.clientX+"px";
    menu.style.background="rgba(0,0,0,0.85)"; menu.style.backdropFilter="blur(10px)";
    menu.style.borderRadius="10px"; menu.style.padding="5px"; menu.style.zIndex=9999;

    const actions = [
        {name:"Delete",func:()=>{delete dir[name]; saveUsers(); buildFileManager(); menu.remove();}},
        {name:"Rename",func:()=>{let nn=prompt("New name",name); if(nn){dir[nn]=dir[name]; delete dir[name]; saveUsers(); buildFileManager(); menu.remove();}}}
    ];

    actions.forEach(a=>{
        const b = document.createElement("div"); b.textContent = a.name;
        b.style.padding="5px 10px"; b.style.cursor="pointer";
        b.onmouseover = ()=>b.style.background="rgba(255,255,255,0.2)";
        b.onmouseout = ()=>b.style.background="transparent";
        b.onclick = a.func;
        menu.appendChild(b);
    });

    document.body.appendChild(menu);
    document.addEventListener("click",()=>{ if(menu) menu.remove(); menu=null; },{once:true});
}

/* ===============================
   TERMINAL APP
================================ */
function buildTerminal(rootDiv){
    const container = document.getElementById(rootDiv);
    container.innerHTML="";
    const output = document.createElement("div");
    output.style.height="300px"; output.style.overflowY="auto"; output.style.background="black"; output.style.color="#0f0"; output.style.padding="10px";
    container.appendChild(output);

    const input = document.createElement("input");
    input.style.width="100%"; input.style.background="black"; input.style.color="#0f0";
    container.appendChild(input);
    input.focus();

    input.addEventListener("keydown",e=>{
        if(e.key==="Enter"){
            const cmd = input.value.trim(); output.innerHTML+="<div>> "+cmd+"</div>";
            executeTerm(cmd,output);
            input.value="";
            output.scrollTop=output.scrollHeight;
        }
    });
}

function executeTerm(cmd,out){
    const args = cmd.split(" "); const c=args[0]; const arg=args[1];
    const dir = getCurrentDir();
    switch(c){
        case "ls": out.innerHTML+= "<div>"+Object.keys(dir).join(" ")+"</div>"; break;
        case "cd": if(arg===".."){ if(path.length>2) path.pop(); } else if(dir[arg]&&dir[arg].type==="folder") path.push(arg); break;
        case "pwd": out.innerHTML+= "<div>"+pathString()+"</div>"; break;
        case "mkdir": if(arg){dir[arg]={type:"folder",children:{},created:Date.now()}; saveUsers();} break;
        case "touch": if(arg){dir[arg]={type:"file",size:0,created:Date.now()}; saveUsers();} break;
        case "clear": out.innerHTML=""; break;
        default: out.innerHTML+="<div>Command not found</div>";
    }
}

/* ===============================
   SYSTEM MONITOR
================================ */
function buildMonitor(rootDiv){
    const container = document.getElementById(rootDiv); container.innerHTML="";
    const cpu = document.createElement("div"); const ram = document.createElement("div");
    container.appendChild(cpu); container.appendChild(ram);
    setInterval(()=>{ cpu.textContent="CPU Usage: "+Math.floor(Math.random()*70)+"%";
                      ram.textContent="RAM Usage: "+Math.floor(Math.random()*80)+"%"; },1500);
}
</script>
